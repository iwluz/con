<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>>_ messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}:root{--bg-dark:#121212;--bg-panel:#1e1e1e;--bg-input:#2d2d2d;--accent:#bb86fc;--accent-hover:#9a67ea;--text-primary:#e0e0e0;--text-secondary:#aaaaaa;--border-radius:12px;--border:1px solid #333333;--online:#00c853;--offline:#ff5252;--typing:#ffd740}body{background-color:var(--bg-dark);color:var(--text-primary);height:100vh;display:flex;justify-content:center;align-items:center}#splashScreen{position:fixed;top:0;left:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;background:radial-gradient(circle at 15% 25%,rgba(25,25,45,0.8) 0%,transparent 40%),radial-gradient(circle at 85% 75%,rgba(35,35,65,0.7) 0%,transparent 40%),linear-gradient(135deg,#0c0c14,#131320);overflow:hidden;font-family:'Roboto',sans-serif;z-index:10000}.center-container{position:relative;display:flex;justify-content:center;align-items:center;width:100%;height:100vh}.animation-container{position:relative;display:flex;justify-content:center;align-items:center;height:200px;width:400px}.symbols{position:absolute;color:#fff;font-size:84px;font-weight:300;opacity:0;transform:translateY(150px);animation:riseUp 1.2s cubic-bezier(0.2,0.8,0.2,1) forwards,moveRight .8s 1.2s cubic-bezier(0.2,0.8,0.2,1) forwards;z-index:10;text-shadow:0 2px 4px rgba(0,0,0,.3);letter-spacing:-4px}.con-text{position:absolute;color:#fff;font-size:84px;font-weight:300;opacity:0;transform:translateX(0);animation:conAppear 1.2s 1.2s cubic-bezier(0.2,0.8,0.2,1) forwards;z-index:5;text-shadow:0 2px 4px rgba(0,0,0,.3);letter-spacing:-4px}.con-text span{display:inline-block;opacity:0;transform:translateY(10px);animation:fadeInChar .4s forwards}.loading{position:absolute;display:flex;gap:10px;opacity:0;transform:translateY(0);animation:loadingAppear .6s 3s cubic-bezier(0.2,0.8,0.2,1) forwards,loadingMoveDown .8s 3s cubic-bezier(0.2,0.8,0.2,1) forwards}.dot{width:12px;height:12px;border-radius:50%;background:#aaa;animation:pulseDot 1.5s infinite;box-shadow:0 1px 2px rgba(0,0,0,.2)}.dot:nth-child(1){animation-delay:0s}.dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}@keyframes riseUp{0%{opacity:0;transform:translateY(150px)}70%{opacity:.9;transform:translateY(-15px)}100%{opacity:1;transform:translateY(0)}}@keyframes moveRight{0%{transform:translateX(0)}100%{transform:translateX(48px)}}@keyframes conAppear{0%{opacity:0;transform:translateX(0)}100%{opacity:1;transform:translateX(-92px)}}@keyframes fadeInChar{0%{opacity:0;transform:translateY(10px) scale(.9)}70%{opacity:.7;transform:translateY(-3px) scale(1.05)}100%{opacity:1;transform:translateY(0) scale(1)}}@keyframes loadingAppear{0%{opacity:0}100%{opacity:1}}@keyframes loadingMoveDown{0%{transform:translateY(0)}100%{transform:translateY(80px)}}@keyframes pulseDot{0%,100%{background:#aaa;transform:scale(1)}50%{background:#fff;transform:scale(1.2)}}.container,.status-bar{display:none}.container{width:100%;max-width:1200px;height:95vh;background-color:var(--bg-panel);border-radius:var(--border-radius);box-shadow:0 0 30px rgba(0,0,0,.5);display:flex;overflow:hidden;border:var(--border)}.auth-container{display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;padding:20px;position:relative;background:linear-gradient(135deg,#1a1a1a 0%,#121212 100%)}.logo{display:flex;align-items:center;margin-bottom:40px;z-index:1}.logo-icon{font-size:48px;font-family:'Courier New',monospace;color:var(--accent);margin-right:15px;font-weight:bold}.auth-box{background-color:rgba(30,30,30,.9);border-radius:var(--border-radius);padding:30px;width:100%;max-width:400px;border:var(--border);box-shadow:0 0 20px rgba(0,0,0,.3);z-index:1}.auth-title{text-align:center;margin-bottom:25px;font-size:24px;color:var(--accent);letter-spacing:1px}.input-group{margin-bottom:20px}label{display:block;margin-bottom:8px;color:var(--text-secondary);font-size:14px}input{width:100%;padding:14px;background-color:var(--bg-input);border:var(--border);border-radius:8px;color:var(--text-primary);font-size:16px;transition:all .3s}input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(187,134,252,.2)}.btn{width:100%;padding:14px;background-color:var(--accent);color:#000;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;margin-top:10px}.btn:hover{background-color:var(--accent-hover);transform:translateY(-2px);box-shadow:0 5px 15px rgba(187,134,252,.3)}.auth-toggle{text-align:center;margin-top:20px;color:var(--text-secondary);font-size:14px}.auth-toggle a{color:var(--accent);text-decoration:none;cursor:pointer;transition:color .3s;font-weight:500}.auth-toggle a:hover{text-decoration:underline}.status-bar{position:fixed;bottom:0;left:0;width:100%;background-color:rgba(30,30,30,.9);padding:10px 20px;font-size:14px;color:var(--text-secondary);border-top:1px solid #333;z-index:1000;display:flex;justify-content:space-between;backdrop-filter:blur(5px)}.status-item{display:flex;align-items:center}.status-indicator{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px}.status-connected{background-color:var(--online)}.status-disconnected{background-color:var(--offline)}.status-processing{background-color:var(--typing);animation:pulse 1.5s infinite}.app-container{display:none;width:100%;height:100%;flex-direction:column}.top-bar{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:var(--border);background-color:rgba(30,30,30,.9);z-index:10;backdrop-filter:blur(5px)}.user-info{display:flex;align-items:center}.avatar{width:40px;height:40px;border-radius:50%;background-color:var(--accent);display:flex;justify-content:center;align-items:center;font-weight:bold;color:#000;margin-right:12px}.username{font-weight:500;font-size:18px}.logout-btn{background:transparent;border:none;color:var(--accent);padding:8px 12px;border-radius:6px;cursor:pointer;transition:all .3s;font-weight:500;display:flex;align-items:center;gap:5px}.logout-btn:hover{background-color:rgba(187,134,252,.1)}.menu-btn{display:none;background:transparent;border:none;color:var(--text-primary);font-size:20px;cursor:pointer;margin-right:15px}.main-content{display:flex;flex:1;overflow:hidden;position:relative}.contacts-panel{width:300px;border-right:var(--border);overflow-y:auto;background-color:rgba(26,26,26,.9);display:flex;flex-direction:column;transition:transform .3s ease;z-index:5}.contacts-header{padding:20px;font-weight:500;font-size:18px;color:var(--text-primary);border-bottom:var(--border);display:flex;align-items:center}.search-box{position:relative;padding:15px;border-bottom:var(--border)}.search-box input{padding-left:40px}.search-box i{position:absolute;left:30px;top:50%;transform:translateY(-50%);color:var(--text-secondary)}.contacts-list{overflow-y:auto;flex:1}.contact{display:flex;align-items:center;padding:15px 20px;cursor:pointer;transition:background-color .3s;position:relative;border-bottom:var(--border)}.contact:hover{background-color:rgba(255,255,255,.05)}.contact.active{background-color:rgba(187,134,252,.1);border-left:3px solid var(--accent)}.contact-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#3700b3);display:flex;justify-content:center;align-items:center;font-weight:bold;color:#000;margin-right:15px}.contact-info{flex:1;min-width:0}.contact-name{font-weight:500;margin-bottom:3px;display:flex;align-items:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.online-dot{display:inline-block;width:8px;height:8px;background-color:var(--online);border-radius:50%;margin-left:8px;flex-shrink:0}.offline-dot{display:inline-block;width:8px;height:8px;background-color:var(--offline);border-radius:50%;margin-left:8px;flex-shrink:0}.last-message{color:var(--text-secondary);font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.chat-container{flex:1;display:flex;flex-direction:column;background-color:rgba(24,24,24,.95);position:relative}.chat-header{padding:15px 20px;border-bottom:var(--border);display:flex;align-items:center;background-color:rgba(30,30,30,.9);z-index:5;backdrop-filter:blur(5px)}.back-btn{display:none;background:transparent;border:none;color:var(--text-primary);font-size:20px;cursor:pointer;margin-right:15px}.current-contact{font-weight:500;font-size:18px;display:flex;align-items:center;flex:1}.typing-indicator{margin-left:10px;color:var(--typing);font-size:14px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.chat-messages{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;background:linear-gradient(rgba(18,18,18,.9),rgba(18,18,18,.9)),radial-gradient(circle at 10% 20%,rgba(40,40,40,.1) 0%,transparent 20%),radial-gradient(circle at 90% 80%,rgba(40,40,40,.1) 0%,transparent 20%)}.message{max-width:80%;padding:12px 16px;margin-bottom:15px;border-radius:18px;position:relative;animation:fadeIn .3s;word-wrap:break-word;line-height:1.5;box-shadow:0 2px 5px rgba(0,0,0,.2)}.message.sent{align-self:flex-end;background:linear-gradient(135deg,var(--accent),#7c4dff);color:#000;border-bottom-right-radius:5px}.message.received{align-self:flex-start;background-color:rgba(50,50,50,.7);color:var(--text-primary);border-bottom-left-radius:5px}.message-time{font-size:11px;opacity:.8;margin-top:5px;text-align:right;display:flex;align-items:center;justify-content:flex-end;gap:5px}.message-status{font-size:12px}.chat-input-container{padding:15px 20px;background-color:rgba(30,30,30,.9);border-top:var(--border);backdrop-filter:blur(5px)}.chat-input-box{display:flex;align-items:center;background-color:var(--bg-input);border-radius:24px;padding:5px 15px;border:var(--border)}.message-input{flex:1;border:none;background:transparent;padding:12px 0;resize:none;height:24px;max-height:150px;font-family:inherit;outline:none;color:var(--text-primary);font-size:16px}.send-btn{width:40px;height:40px;border-radius:50%;background-color:var(--accent);color:#000;border:none;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .3s;flex-shrink:0;margin-left:10px}.send-btn:hover{background-color:var(--accent-hover);transform:scale(1.05)}.notification{position:fixed;top:20px;right:20px;background:var(--bg-panel);color:var(--text-primary);padding:15px 25px;border-radius:var(--border-radius);box-shadow:0 5px 15px rgba(0,0,0,.3);z-index:10000;display:flex;align-items:center;gap:12px;animation:slideIn .3s,fadeOut .3s 2.7s forwards;border-left:4px solid var(--accent)}.notification-icon{font-size:20px;color:var(--accent)}@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes fadeOut{from{opacity:1}to{opacity:0;visibility:hidden}}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:rgba(255,255,255,.05);border-radius:4px}::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--accent-hover)}@media (max-width:768px){.container{height:100vh;border-radius:0}.auth-container{padding:15px}.auth-box{padding:20px}.contacts-panel{position:absolute;top:0;left:0;bottom:0;width:100%;transform:translateX(0);z-index:20}.contacts-panel.hidden{transform:translateX(-100%)}.chat-container{width:100%}.chat-container.hidden{display:none}.menu-btn{display:block}.back-btn{display:block}.contact-name,.last-message{max-width:calc(100% - 60px)}}@media (max-width:480px){.auth-box{padding:15px}.auth-title{font-size:20px}.top-bar,.chat-header{padding:12px 15px}.chat-messages{padding:15px}.message{max-width:90%}}
    </style>
</head>
<body>
    <div id="splashScreen">
        <div class="center-container">
            <div class="animation-container">
                <div class="symbols">&gt;_</div>
                <div class="con-text"><span>c</span><span>o</span><span>n</span></div>
                <div class="loading">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="auth-container" id="authScreen">
            <div class="logo">
                <div class="logo-icon">>_</div>
            </div>
            
            <div class="auth-box" id="loginForm">
                <div class="auth-title">вход в >_ messenger</div>
                <div class="input-group">
                    <label for="loginUsername">имя пользователя</label>
                    <input type="text" id="loginUsername" placeholder="придумай ник" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="loginPassword">пароль</label>
                    <input type="password" id="loginPassword" placeholder="придумай пароль" autocomplete="off">
                </div>
                <button class="btn" id="loginBtn">войти!</button>
                <div class="auth-toggle">
                    еще нет аккаунта? <a id="showRegister">создать!</a>
                </div>
            </div>
            
            <div class="auth-box" id="registerForm" style="display: none;">
                <div class="auth-title">регистрация</div>
                <div class="input-group">
                    <label for="registerUsername">имя пользователя</label>
                    <input type="text" id="registerUsername" placeholder="придумай ник" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="registerPassword">пароль</label>
                    <input type="password" id="registerPassword" placeholder="придумай пароль" autocomplete="off">
                </div>
                <div class="input-group">
                    <label for="registerConfirm">подтверди пароль</label>
                    <input type="password" id="registerConfirm" placeholder=" " autocomplete="off">
                </div>
                <button class="btn" id="registerBtn">создать аккаунт!</button>
                <div class="auth-toggle">
                    уже есть аккаунт? <a id="showLogin">войти!</a>
                </div>
            </div>
        </div>
        
        <div class="app-container" id="appScreen">
            <div class="top-bar">
                <button class="menu-btn" id="menuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info">
                    <div class="avatar" id="userAvatar">U</div>
                    <div class="username" id="userName">User</div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> выйти
                </button>
            </div>
            
            <div class="main-content">
                <div class="contacts-panel" id="contactsPanel">
                    <div class="contacts-header">
                        контакты
                    </div>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchContact" placeholder="Поиск контактов..." autocomplete="off">
                    </div>
                    <div class="contacts-list" id="contactsList">
                    </div>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="chat-header">
                        <button class="back-btn" id="backBtn">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <div class="current-contact" id="currentContact">
                            выбери контакт
                            <span class="typing-indicator" id="typingIndicator" style="display: none;">печатает...</span>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input-box">
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="Введите сообщение..." 
                                rows="1"
                                autocomplete="off"
                            ></textarea>
                            <button class="send-btn" id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">подключение...</span>
        </div>
        <div class="status-item">
            <span id="connectionInfo">>_ messenger</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const CONFIG = {
            RECONNECT_DELAY: 3000,
            MAX_RECONNECTS: Infinity,
            TYPING_TIMEOUT: 2000,
            MESSAGE_RETRY_DELAY: 5000
        };

        const STATE = {
            currentUser: null,
            activeContact: null,
            socket: null,
            reconnectAttempts: 0,
            typingTimeout: null,
            pendingMessages: {},
            isMobile: window.innerWidth <= 768
        };

        const ELEMENTS = {
            authScreen: document.getElementById('authScreen'),
            appScreen: document.getElementById('appScreen'),
            loginForm: document.getElementById('loginForm'),
            registerForm: document.getElementById('registerForm'),
            statusIndicator: document.getElementById('statusIndicator'),
            statusText: document.getElementById('statusText'),
            loginBtn: document.getElementById('loginBtn'),
            registerBtn: document.getElementById('registerBtn'),
            showRegister: document.getElementById('showRegister'),
            showLogin: document.getElementById('showLogin'),
            logoutBtn: document.getElementById('logoutBtn'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            contactsList: document.getElementById('contactsList'),
            currentContact: document.getElementById('currentContact'),
            chatMessages: document.getElementById('chatMessages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            typingIndicator: document.getElementById('typingIndicator'),
            searchContact: document.getElementById('searchContact'),
            contactsPanel: document.getElementById('contactsPanel'),
            chatContainer: document.getElementById('chatContainer'),
            menuBtn: document.getElementById('menuBtn'),
            backBtn: document.getElementById('backBtn')
        };

        function initSocket() {
            const serverUrl = window.location.origin;
            STATE.socket = io(serverUrl, {
                reconnection: true,
                reconnectionAttempts: CONFIG.MAX_RECONNECTS,
                reconnectionDelay: CONFIG.RECONNECT_DELAY,
                transports: ['websocket'],
                autoConnect: true,
                withCredentials: true
            });

            STATE.socket.on('connect', () => {
                updateStatus('connected', 'онлайн');
                STATE.reconnectAttempts = 0;
                retryPendingMessages();
                const savedUser = localStorage.getItem('messenger_user');
                if (savedUser) {
                    STATE.socket.emit('login', JSON.parse(savedUser));
                }
            });

            STATE.socket.on('disconnect', () => {
                updateStatus('disconnected', 'отключено');
            });

            STATE.socket.on('connect_error', () => {
                updateStatus('error', 'ошибка подключения');
            });

            STATE.socket.on('auth_success', (data) => {
                STATE.currentUser = data.username;
                showAppInterface();
                localStorage.setItem('messenger_user', JSON.stringify({
                    username: data.username,
                    password: localStorage.getItem('messenger_password')
                }));
            });

            STATE.socket.on('auth_error', (error) => {
                showNotification(`Ошибка: ${error}`);
                localStorage.removeItem('messenger_user');
                localStorage.removeItem('messenger_password');
            });

            STATE.socket.on('reg_success', (message) => {
                showNotification(message);
                showLoginForm();
            });

            STATE.socket.on('reg_error', (error) => {
                showNotification(`Ошибка: ${error}`);
            });

            STATE.socket.on('online_users', (users) => {
                updateContactsList(users);
            });

            STATE.socket.on('user_status', (data) => {
                updateContactStatus(data.username, data.online);
            });

            STATE.socket.on('user_online', (username) => {
                updateContactStatus(username, true);
            });

            STATE.socket.on('user_offline', (username) => {
                updateContactStatus(username, false);
            });

            STATE.socket.on('new_message', (message) => {
                if (message.recipient === STATE.currentUser) {
                    addMessageToChat(message, 'received');
                    playNotificationSound();
                    if (!document.hasFocus() && Notification.permission === 'granted') {
                        new Notification(`новое сообщение от ${message.sender}!`, {
                            body: message.text
                        });
                    }
                }
            });

            STATE.socket.on('message_sent', (data) => {
                updateMessageStatus(data.temp_id, data.message_id, data.status);
            });

            STATE.socket.on('message_history', (data) => {
                if (data.contact === STATE.activeContact) {
                    renderMessageHistory(data.messages);
                }
            });

            STATE.socket.on('typing_start', (data) => {
                if (data.sender === STATE.activeContact) {
                    ELEMENTS.typingIndicator.textContent = `${data.sender} печатает...`;
                    ELEMENTS.typingIndicator.style.display = 'inline';
                }
            });

            STATE.socket.on('typing_stop', (data) => {
                if (data.sender === STATE.activeContact) {
                    ELEMENTS.typingIndicator.style.display = 'none';
                }
            });

            STATE.socket.on('unread_messages', (data) => {
                if (data.sender === STATE.activeContact) {
                    data.messages.forEach(msg => {
                        addMessageToChat(msg, 'received');
                    });
                } else {
                    showNotification(`новые сообщения от ${data.sender}!`);
                }
            });

            async function sendMessageWithRetry(messageData, retries = 3) {
                return new Promise((resolve) => {
                    const trySend = (attempt = 0) => {
                        if (STATE.socket.connected) {
                            STATE.socket.emit('send_message', messageData, (ack) => {
                                if (ack && ack.status === 'delivered') {
                                    resolve(true);
                                } else {
                                    if (attempt < retries) {
                                        setTimeout(() => trySend(attempt + 1), CONFIG.MESSAGE_RETRY_DELAY);
                                    } else {
                                        resolve(false);
                                    }
                                }
                            });
                        } else {
                            if (attempt < retries) {
                                setTimeout(() => trySend(attempt + 1), CONFIG.MESSAGE_RETRY_DELAY);
                            } else {
                                resolve(false);
                            }
                        }
                    };
                    trySend();
                });
            }

            async function sendMessage() {
                const message = ELEMENTS.messageInput.value.trim();
                if (!message || !STATE.activeContact) return;
                const tempId = `temp_${Date.now()}`;
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                addMessageToChat({
                    id: tempId,
                    sender: STATE.currentUser,
                    text: message,
                    timestamp: timestamp,
                    status: 'sending'
                }, 'sent');
                const messageData = {
                    temp_id: tempId,
                    recipient: STATE.activeContact,
                    message: message
                };
                STATE.pendingMessages[tempId] = messageData;
                const success = await sendMessageWithRetry(messageData);
                if (success) {
                    delete STATE.pendingMessages[tempId];
                } else {
                    updateMessageStatus(tempId, null, 'failed');
                }
                ELEMENTS.messageInput.value = '';
                ELEMENTS.messageInput.style.height = 'auto';
            }

            STATE.sendMessage = sendMessage;
        }

        function updateStatus(status, text) {
            ELEMENTS.statusIndicator.className = 'status-indicator';
            ELEMENTS.statusText.textContent = text;
            switch(status) {
                case 'connected':
                    ELEMENTS.statusIndicator.classList.add('status-connected');
                    break;
                case 'disconnected':
                    ELEMENTS.statusIndicator.classList.add('status-disconnected');
                    break;
                case 'error':
                    ELEMENTS.statusIndicator.classList.add('status-processing');
                    break;
            }
        }

        function showAppInterface() {
            ELEMENTS.authScreen.style.display = 'none';
            ELEMENTS.appScreen.style.display = 'flex';
            ELEMENTS.userName.textContent = STATE.currentUser;
            ELEMENTS.userAvatar.textContent = STATE.currentUser.charAt(0).toUpperCase();
            STATE.socket.emit('get_online_users');
            if (STATE.isMobile) {
                ELEMENTS.contactsPanel.classList.remove('hidden');
                ELEMENTS.chatContainer.classList.add('hidden');
            }
        }

        function updateContactsList(users) {
            ELEMENTS.contactsList.innerHTML = '';
            if (users.length === 0) {
                ELEMENTS.contactsList.innerHTML = `
                    <div class="no-contacts">
                        <div style="text-align: center; padding: 30px; color: var(--text-secondary)">
                            <i class="fas fa-user-friends" style="font-size: 40px; margin-bottom: 15px;"></i>
                            <p>нет доступных контактов :(</p>
                        </div>
                    </div>
                `;
                return;
            }
            users.forEach(username => {
                if (username !== STATE.currentUser) {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact';
                    contactElement.dataset.username = username;
                    contactElement.innerHTML = `
                        <div class="contact-avatar">${username.charAt(0).toUpperCase()}</div>
                        <div class="contact-info">
                            <div class="contact-name">
                                ${username}
                                <span class="status-dot online"></span>
                            </div>
                            <div class="last-message" style="color: var(--online)">В сети</div>
                        </div>
                    `;
                    contactElement.addEventListener('click', () => {
                        selectContact(username);
                    });
                    ELEMENTS.contactsList.appendChild(contactElement);
                }
            });
        }

        function updateContactStatus(username, isOnline) {
            const contact = ELEMENTS.contactsList.querySelector(`.contact[data-username="${username}"]`);
            if (contact) {
                const dot = contact.querySelector('.status-dot');
                const statusText = contact.querySelector('.last-message');
                if (dot) {
                    dot.className = `status-dot ${isOnline ? 'online' : 'offline'}`;
                }
                if (statusText) {
                    statusText.textContent = isOnline ? 'в сети ^-^' : 'не в сети >_<';
                    statusText.style.color = isOnline ? 'var(--online)' : 'var(--offline)';
                }
            }
        }

        function selectContact(username) {
            STATE.activeContact = username;
            ELEMENTS.currentContact.innerHTML = username;
            ELEMENTS.typingIndicator.style.display = 'none';
            ELEMENTS.chatMessages.innerHTML = '';
            document.querySelectorAll('.contact').forEach(el => {
                el.classList.remove('active');
            });
            const contact = ELEMENTS.contactsList.querySelector(`.contact[data-username="${username}"]`);
            if (contact) {
                contact.classList.add('active');
            }
            STATE.socket.emit('get_message_history', {
                contact: username
            });
            if (STATE.isMobile) {
                ELEMENTS.contactsPanel.classList.add('hidden');
                ELEMENTS.chatContainer.classList.remove('hidden');
            }
        }

        function addMessageToChat(message, type) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            messageElement.dataset.id = message.id;
            let statusIcon = '';
            if (type === 'sent') {
                if (message.status === 'sending') {
                    statusIcon = '<i class="fas fa-circle-notch fa-spin"></i>';
                } else if (message.status === 'sent' || message.status === 'failed') {
                    statusIcon = '<i class="fas fa-exclamation-circle"></i>';
                } else if (message.status === 'delivered') {
                    statusIcon = '<i class="fas fa-check"></i>';
                } else {
                    statusIcon = '<i class="fas fa-check-double"></i>';
                }
            }
            messageElement.innerHTML = `
                <div class="message-text">${message.text}</div>
                <div class="message-time">
                    ${message.timestamp}
                    ${type === 'sent' ? `<span class="message-status">${statusIcon}</span>` : ''}
                </div>
            `;
            ELEMENTS.chatMessages.appendChild(messageElement);
            ELEMENTS.chatMessages.scrollTop = ELEMENTS.chatMessages.scrollHeight;
        }

        function updateMessageStatus(tempId, messageId, status) {
            const messageElement = ELEMENTS.chatMessages.querySelector(`.message[data-id="${tempId}"]`);
            if (messageElement) {
                if (messageId) messageElement.dataset.id = messageId;
                let statusIcon = '';
                if (status === 'sending') {
                    statusIcon = '<i class="fas fa-circle-notch fa-spin"></i>';
                } else if (status === 'sent' || status === 'failed') {
                    statusIcon = '<i class="fas fa-exclamation-circle"></i>';
                } else if (status === 'delivered') {
                    statusIcon = '<i class="fas fa-check"></i>';
                } else {
                    statusIcon = '<i class="fas fa-check-double"></i>';
                }
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement) {
                    statusElement.innerHTML = statusIcon;
                    statusElement.style.color = status === 'failed' ? 'var(--offline)' : 'inherit';
                }
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon"><i class="fas fa-info-circle"></i></div>
                <div>${message}</div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3');
                audio.volume = 0.3;
                audio.play().catch(e => console.log("Audio error"));
            } catch (e) {
                console.log("Audio error");
            }
        }

        function retryPendingMessages() {
            Object.values(STATE.pendingMessages).forEach(async (messageData) => {
                const success = await sendMessageWithRetry(messageData);
                if (success) {
                    delete STATE.pendingMessages[messageData.temp_id];
                }
            });
        }

        function initEventListeners() {
            ELEMENTS.loginBtn.addEventListener('click', () => {
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                if (!username || !password) {
                    showNotification('заполни все поля!');
                    return;
                }
                localStorage.setItem('messenger_password', password);
                STATE.socket.emit('login', { username, password });
            });
            
            ELEMENTS.registerBtn.addEventListener('click', () => {
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;
                if (!username || !password || !confirm) {
                    showNotification('заполни все поля!');
                    return;
                }
                if (password !== confirm) {
                    showNotification('пароли не совпадают(');
                    return;
                }
                STATE.socket.emit('register', { username, password });
            });
            
            ELEMENTS.showRegister.addEventListener('click', () => {
                ELEMENTS.loginForm.style.display = 'none';
                ELEMENTS.registerForm.style.display = 'block';
            });
            
            ELEMENTS.showLogin.addEventListener('click', () => {
                ELEMENTS.registerForm.style.display = 'none';
                ELEMENTS.loginForm.style.display = 'block';
            });
            
            ELEMENTS.logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('messenger_user');
                localStorage.removeItem('messenger_password');
                location.reload();
            });
            
            ELEMENTS.sendBtn.addEventListener('click', STATE.sendMessage);
            
            ELEMENTS.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    STATE.sendMessage();
                }
            });
            
            ELEMENTS.messageInput.addEventListener('input', () => {
                if (!STATE.activeContact) return;
                STATE.socket.emit('start_typing', {
                    recipient: STATE.activeContact
                });
                clearTimeout(STATE.typingTimeout);
                STATE.typingTimeout = setTimeout(() => {
                    STATE.socket.emit('stop_typing', {
                        recipient: STATE.activeContact
                    });
                }, CONFIG.TYPING_TIMEOUT);
                ELEMENTS.messageInput.style.height = 'auto';
                ELEMENTS.messageInput.style.height = Math.min(ELEMENTS.messageInput.scrollHeight, 150) + 'px';
            });
            
            ELEMENTS.searchContact.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('.contact').forEach(contact => {
                    const username = contact.dataset.username.toLowerCase();
                    contact.style.display = username.includes(term) ? 'flex' : 'none';
                });
            });
            
            ELEMENTS.menuBtn.addEventListener('click', () => {
                ELEMENTS.contactsPanel.classList.remove('hidden');
                ELEMENTS.chatContainer.classList.add('hidden');
            });
            
            ELEMENTS.backBtn.addEventListener('click', () => {
                ELEMENTS.contactsPanel.classList.remove('hidden');
                ELEMENTS.chatContainer.classList.add('hidden');
            });
            
            window.addEventListener('resize', () => {
                STATE.isMobile = window.innerWidth <= 768;
            });
        }

        function renderMessageHistory(messages) {
            ELEMENTS.chatMessages.innerHTML = '';
            if (messages.length === 0) {
                ELEMENTS.chatMessages.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary)">
                        <i class="fas fa-comments" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <p>начни общение с ${STATE.activeContact}!</p>
                    </div>
                `;
                return;
            }
            messages.forEach(msg => {
                const type = msg.sender === STATE.currentUser ? 'sent' : 'received';
                addMessageToChat(msg, type);
            });
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        function initApp() {
            initSocket();
            initEventListeners();
            updateStatus('processing', 'подключение...');
            requestNotificationPermission();
        }

        window.addEventListener('DOMContentLoaded', function() {
            const conChars = document.querySelectorAll('.con-text span');
            conChars.forEach((char, index) => {
                char.style.animationDelay = `${1.2 + index * 0.15}s`;
            });
            setTimeout(function() {
                document.getElementById('splashScreen').style.display = 'none';
                document.querySelector('.container').style.display = 'flex';
                document.querySelector('.status-bar').style.display = 'flex';
            }, 7000);
            initApp();
        });
    </script>
</body>
</html>
